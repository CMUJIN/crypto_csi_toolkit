name: Auto Crypto Chip Analysis

on:
  schedule:
    - cron: "0 8,16 * * *"  # 北京时间16:00和00:00（UTC+8）
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1️⃣ 拉取仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2️⃣ 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      # Step 3️⃣ 安装依赖
      - name: Install dependencies
        run: |
          pip install -r requirements.txt || pip install pandas matplotlib numpy openpyxl akshare notion-client

      # Step 4️⃣ 清理旧文件
      - name: Clean old docs and data
        run: |
          echo "[INFO] Cleaning old docs..."
          find docs/ -type f -not -name '.gitkeep' -delete || true
          echo "[INFO] Cleaning old data..."
          find data/ -type f -not -name '.gitkeep' -delete || true

      # Step 5️⃣ 抓取最新行情数据
      - name: Run data downloader
        run: |
          echo "[INFO] Downloading latest crypto/futures data..."
          # 示例: 抓取BTC/ETH数据，可按需修改 symbols
          python cn_futures_downloader.py --symbols BTCUSDT,ETHUSDT --freq 1h --start 2025-10-01 --out ./data

      # Step 6️⃣ 运行筹码强度分析
      - name: Run chip strength analysis
        run: |
          echo "[INFO] Running chip strength analysis..."
          for f in data/*.csv; do
            echo "[~] Processing $f ..."
            python crypto_chip_timeline_analysis_PRO_v3.9.5.py "$f"
          done

      # Step 7️⃣ 上传结果至 Notion
      - name: Upload analysis results to Notion
        run: |
          echo "[INFO] Uploading results to Notion..."
          python upload_to_notion.py

      # Step 8️⃣ 提交到 GitHub（强制 commit）
      - name: Commit and push updated docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "[INFO] Adding timestamp for visibility..."
          echo "$(date)" > docs/.build_timestamp.txt

          git add -A docs data
          git commit --allow-empty -m "Auto update docs ($(date '+%Y-%m-%d %H:%M:%S'))"
          git push
