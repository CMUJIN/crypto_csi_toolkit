name: Auto Crypto CSI Analysis

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'  # every 4 hours

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pandas numpy matplotlib requests openpyxl pyyaml notion-client

      - name: Create runner script
        run: |
          cat > run_analysis.py << 'PY'
          import subprocess, yaml
          from pathlib import Path

          cfg_path = Path('config.yaml')
          if not cfg_path.exists():
              raise FileNotFoundError('Missing config.yaml')

          cfg = yaml.safe_load(cfg_path.read_text())

          for item in cfg.get('symbols', []):
              symbol = item['symbol']
              freq   = item.get('freq', '1h')
              start  = item.get('start', '2025-08-01')
              print(f'=== Processing {symbol} ({freq}) ===')

              subprocess.run([
                  'python', 'crypto_cdd_fetcher.py',
                  '--symbol', symbol,
                  '--freq',   freq,
                  '--start',  start,
                  '--out',    f'data/Binance_{symbol}_{freq}_{start}_to_latest.csv'
              ], check=True)

              subprocess.run([
                  'python', 'crypto_chip_timeline_analysis_PRO_v3.9.1.py',
                  f'data/Binance_{symbol}_{freq}_{start}_to_latest.csv',
                  '--window_strength', '5',
                  '--window_zone',     '60',
                  '--bins_pct',        '0.5',
                  '--beta',            '0.7',
                  '--half_life',       '10000000',
                  '--quantile',        '0.8',
                  '--ma_period',       '10',
                  '--smooth',          '3'
              ], check=True)
          PY

      - name: Run analysis
        run: python run_analysis.py

      - name: Commit and push results
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add docs/
          git commit -m "Auto update: $(date '+%Y-%m-%d %H:%M')" || echo "No changes"
          git push || echo "No permission to push"

      - name: Upload results to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          pip install notion-client
          python upload_to_notion.py
